<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>Sniplicity Configuration</title>
    <link rel="stylesheet" href="/sniplicity/css">
    <link rel="stylesheet" href="/sniplicity/custom.css">
</head>
<body>
    <main class="container">
        <header>
            <hgroup>
                <h1>sniplicity</h1>
                <p>Static Site Generator Configuration</p>
            </hgroup>
        </header>

        <article>
            <header>
                <h3>Current Configuration</h3>
            </header>
            
            <table>
                <tbody>
                    <tr>
                        <td><strong>Input Directory</strong></td>
                        <td><code id="current-input">Loading...</code></td>
                    </tr>
                    <tr>
                        <td><strong>Output Directory</strong></td>
                        <td><code id="current-output">Loading...</code></td>
                    </tr>
                    <tr>
                        <td><strong>Server Port</strong></td>
                        <td><code id="current-port">Loading...</code></td>
                    </tr>
                    <tr>
                        <td><strong>Status</strong></td>
                        <td><code id="current-status">Loading...</code></td>
                    </tr>
                </tbody>
            </table>
        </article>
        
        <form id="config-form">
            <fieldset>
                <legend><strong>Configuration Settings</strong></legend>
                
                <label for="input-dir">
                    Input Directory
                    <input type="text" id="input-dir" name="input-dir" readonly>
                    <small>This is determined by where sniplicity was launched</small>
                </label>
                
                <label for="output-dir">
                    Output Directory
                    <input type="text" id="output-dir" name="output-dir" placeholder="build">
                    <small>Relative to input directory or absolute path</small>
                </label>
                
                <label for="port">
                    Server Port
                    <input type="number" id="port" name="port" min="1024" max="65535" value="3000">
                </label>
                
                <fieldset>
                    <legend><strong>Options</strong></legend>
                    <label for="watch">
                        <input type="checkbox" id="watch" name="watch" role="switch">
                        Watch for file changes
                    </label>
                    <label for="serve">
                        <input type="checkbox" id="serve" name="serve" role="switch">
                        Enable web server
                    </label>
                    <label for="verbose">
                        <input type="checkbox" id="verbose" name="verbose" role="switch">
                        Verbose logging
                    </label>
                    <label for="imgsize">
                        <input type="checkbox" id="imgsize" name="imgsize" role="switch">
                        Auto-add width/height to images
                    </label>
                </fieldset>
            </fieldset>
            
            <div class="grid">
                <button type="button" class="secondary" onclick="loadConfig()">Reset</button>
                <button type="submit">Save & Apply</button>
            </div>
        </form>
        
        <div id="status" role="alert" style="display: none;"></div>
    </main>

    <script>
        let currentConfig = {};
        
        // Load current configuration
        async function loadConfig() {
            try {
                const response = await fetch('/sniplicity/api/config');
                currentConfig = await response.json();
                
                // Update current config display
                document.getElementById('current-input').textContent = currentConfig.input_dir || 'N/A';
                document.getElementById('current-output').textContent = currentConfig.output_dir || 'N/A';
                document.getElementById('current-port').textContent = currentConfig.port || 'N/A';
                document.getElementById('current-status').textContent = 
                    currentConfig.serve ? 'Serving & Watching' : 
                    currentConfig.watch ? 'Watching' : 'Static Build';
                
                // Update form fields
                document.getElementById('input-dir').value = currentConfig.input_dir || '';
                document.getElementById('output-dir').value = currentConfig.output_dir || 'build';
                document.getElementById('port').value = currentConfig.port || 3000;
                document.getElementById('watch').checked = currentConfig.watch || false;
                document.getElementById('serve').checked = currentConfig.serve || false;
                document.getElementById('verbose').checked = currentConfig.verbose || false;
                document.getElementById('imgsize').checked = currentConfig.imgsize !== undefined ? currentConfig.imgsize : true;
                
            } catch (error) {
                showStatus('Error loading configuration: ' + error.message, 'error');
            }
        }
        
        // Save configuration
        async function saveConfig(formData) {
            try {
                const response = await fetch('/sniplicity/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showStatus('Configuration saved successfully!', 'success');
                    
                    // If port changed, redirect to new port after a delay
                    if (formData.port !== currentConfig.port) {
                        setTimeout(() => {
                            window.location.href = `http://127.0.0.1:${formData.port}/sniplicity`;
                        }, 2000);
                    } else {
                        // Reload config to show updated status
                        setTimeout(loadConfig, 1000);
                    }
                } else {
                    showStatus('Error: ' + result.error, 'error');
                }
            } catch (error) {
                showStatus('Error saving configuration: ' + error.message, 'error');
            }
        }
        
        // Show status message using Pico's styling
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.style.display = 'block';
            
            // Use Pico's article styling for status messages
            if (type === 'success') {
                status.style.backgroundColor = 'var(--pico-ins-color)';
                status.style.color = 'white';
                status.style.padding = '1rem';
                status.style.borderRadius = 'var(--pico-border-radius)';
                status.style.marginTop = '1rem';
            } else {
                status.style.backgroundColor = 'var(--pico-del-color)';
                status.style.color = 'white';
                status.style.padding = '1rem';
                status.style.borderRadius = 'var(--pico-border-radius)';
                status.style.marginTop = '1rem';
            }
            
            if (type === 'success') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
        }
        
        // Handle form submission
        document.getElementById('config-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                input_dir: document.getElementById('input-dir').value,
                output_dir: document.getElementById('output-dir').value,
                port: parseInt(document.getElementById('port').value),
                watch: document.getElementById('watch').checked,
                serve: document.getElementById('serve').checked,
                verbose: document.getElementById('verbose').checked,
                imgsize: document.getElementById('imgsize').checked
            };
            
            saveConfig(formData);
        });
        
        // Load config on page load
        document.addEventListener('DOMContentLoaded', loadConfig);
    </script>
</body>
</html>